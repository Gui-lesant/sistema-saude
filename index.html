<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão em Saúde - Passo Fundo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .grid-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .contact-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .contact-card:hover {
            transform: translateX(5px);
        }
        
        .filter-active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <i class="fas fa-hospital-alt text-3xl text-blue-600 mr-3"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Gestão em Saúde - Passo Fundo</h1>
                        <p class="text-sm text-gray-600">Dashboard interativo para gestão de unidades de saúde</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors shadow-sm">
                        <i class="fas fa-sync-alt mr-2"></i> Atualizar
                    </button>
                    
                    <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors shadow-sm">
                        <i class="fas fa-file-pdf mr-2"></i> PDF
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <!-- Sistema de Filtros Avançados -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6 fade-in">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Busca Principal -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-1"></i> Busca Avançada
                    </label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Buscar por unidade, enfermeiro, endereço, telefone..." 
                               class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors shadow-sm">
                        <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- Filtro Rápido -->
                <div class="lg:w-64">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-filter mr-1"></i> Filtro Rápido
                    </label>
                    <select id="quickFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors shadow-sm">
                        <option value="">Todos os registros</option>
                        <option value="vacina:Sim">Com Sala de Vacina</option>
                        <option value="vacina:Não">Sem Sala de Vacina</option>
                        <option value="tipo:ESF">Apenas ESF</option>
                        <option value="tipo:UBS">Apenas UBS</option>
                        <option value="territorio:UPF">Território UPF</option>
                        <option value="territorio:UFFS">Território UFFS</option>
                    </select>
                </div>
            </div>
            
            <!-- Filtros em Lote -->
            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 mb-1">Território</span>
                    <select id="territorioFilter" class="text-sm px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="UPF">UPF</option>
                        <option value="UFFS">UFFS</option>
                        <option value="IMED">IMED</option>
                        <option value="FASURGS">FASURGS</option>
                    </select>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 mb-1">Tipo Unidade</span>
                    <select id="tipoFilter" class="text-sm px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="ESF">ESF</option>
                        <option value="UBS">UBS</option>
                        <option value="CAPS">CAPS</option>
                        <option value="CAIS">CAIS</option>
                        <option value="Amb">Ambulatório</option>
                    </select>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 mb-1">Status Vacina</span>
                    <select id="vacinaFilter" class="text-sm px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="Sim">Com Vacina</option>
                        <option value="Não">Sem Vacina</option>
                    </select>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 mb-1">Equipe</span>
                    <select id="equipeFilter" class="text-sm px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <option value="">Todas</option>
                        <option value="medico">Com Médico</option>
                        <option value="odonto">Com Odonto</option>
                        <option value="multi">Com Multiprofissional</option>
                    </select>
                </div>
            </div>
            
            <!-- Controles -->
            <div class="mt-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600" id="resultCount">0 unidades</span>
                    <span class="text-sm text-gray-400" id="selectedCount"></span>
                </div>
                <div class="flex space-x-2">
                    <button id="clearFilters" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 rounded border border-gray-300 hover:border-gray-400 transition-colors">
                        <i class="fas fa-times mr-1"></i> Limpar Filtros
                    </button>
                    <button id="toggleView" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded transition-colors">
                        <i class="fas fa-th-large mr-1"></i> Alternar Visualização
                    </button>
                </div>
            </div>
        </div>

        <!-- Métricas em Tempo Real -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 card-hover border-l-4 border-blue-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">Total de Unidades</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalUnits">0</h3>
                    </div>
                    <i class="fas fa-hospital text-blue-500 text-xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-4 card-hover border-l-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">Com Sala de Vacina</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="vacinaUnits">0</h3>
                    </div>
                    <i class="fas fa-syringe text-green-500 text-xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-4 card-hover border-l-4 border-purple-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">Diferentes Territórios</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="territoriosCount">0</h3>
                    </div>
                    <i class="fas fa-map-marker-alt text-purple-500 text-xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-4 card-hover border-l-4 border-orange-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">Unidades ESF</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="esfUnits">0</h3>
                    </div>
                    <i class="fas fa-user-md text-orange-500 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Área de Resultados -->
        <div id="resultsArea">
            <!-- Vista em Cards (padrão) -->
            <div id="cardsView" class="grid-stack fade-in">
                <!-- Cards serão gerados aqui -->
            </div>
            
            <!-- Vista em Tabela -->
            <div id="tableView" class="hidden bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="unidade">
                                    Unidade <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="enfermeiro">
                                    Enfermeiro <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Contatos
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="vacina">
                                    Vacina <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="territorio">
                                    Território <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Dados da tabela -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Estado de Carregamento -->
            <div id="loadingState" class="text-center py-12">
                <div class="loading mx-auto mb-4" style="border-top-color: #3b82f6; width: 40px; height: 40px;"></div>
                <p class="text-gray-600">Conectando à planilha e carregando dados...</p>
                <p class="text-sm text-gray-400 mt-2" id="loadingDetail"></p>
            </div>
            
            <!-- Estado Sem Resultados -->
            <div id="noResults" class="hidden text-center py-12">
                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 text-lg">Nenhuma unidade encontrada</p>
                <p class="text-gray-400 mt-1">Tente ajustar os filtros de busca</p>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="unitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Detalhes da Unidade</h3>
                        <p class="text-gray-600 mt-1" id="modalSubtitle"></p>
                    </div>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 bg-white rounded-full p-2 shadow-sm">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]" id="modalContent">
                <!-- Conteúdo dinâmico -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center text-sm text-gray-600">
                <div class="mb-4 md:mb-0">
                    <p>Dashboard de Gestão em Saúde - Prefeitura de Passo Fundo</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span>Dados da planilha oficial</span>
                    <span>•</span>
                    <span id="lastUpdate">Última atualização: -</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Configuração principal
        const CONFIG = {
            spreadsheetId: '1QTPypA8lmlqeSveShPBI4HY9up6cOUcfulGDAyrP_BQ',
            gid: '291026320',
            cacheTimeout: 10 * 60 * 1000, // 10 minutos
            useOpenSheet: true // Usa opensheet.elk.sh como proxy
        };

        // Estado da aplicação
        let appState = {
            allData: [],
            filteredData: [],
            currentView: 'cards',
            currentSort: { field: 'unidade', direction: 'asc' },
            filters: {
                search: '',
                quick: '',
                territorio: '',
                tipo: '',
                vacina: '',
                equipe: ''
            }
        };

        // Elementos DOM
        const elements = {
            // Filtros
            searchInput: document.getElementById('searchInput'),
            quickFilter: document.getElementById('quickFilter'),
            territorioFilter: document.getElementById('territorioFilter'),
            tipoFilter: document.getElementById('tipoFilter'),
            vacinaFilter: document.getElementById('vacinaFilter'),
            equipeFilter: document.getElementById('equipeFilter'),
            clearFilters: document.getElementById('clearFilters'),
            toggleView: document.getElementById('toggleView'),
            
            // Resultados
            cardsView: document.getElementById('cardsView'),
            tableView: document.getElementById('tableView'),
            tableBody: document.getElementById('tableBody'),
            loadingState: document.getElementById('loadingState'),
            noResults: document.getElementById('noResults'),
            resultsArea: document.getElementById('resultsArea'),
            
            // Métricas
            resultCount: document.getElementById('resultCount'),
            selectedCount: document.getElementById('selectedCount'),
            totalUnits: document.getElementById('totalUnits'),
            vacinaUnits: document.getElementById('vacinaUnits'),
            territoriosCount: document.getElementById('territoriosCount'),
            esfUnits: document.getElementById('esfUnits'),
            lastUpdate: document.getElementById('lastUpdate'),
            loadingDetail: document.getElementById('loadingDetail'),
            
            // Ações
            refreshBtn: document.getElementById('refreshBtn'),
            exportBtn: document.getElementById('exportBtn'),
            
            // Modal
            unitModal: document.getElementById('unitModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalSubtitle: document.getElementById('modalSubtitle'),
            modalContent: document.getElementById('modalContent'),
            closeModal: document.getElementById('closeModal')
        };

        // Classe principal da aplicação
        class HealthDashboardApp {
            constructor() {
                this.dataManager = new DataManager();
                this.renderer = new Renderer();
                this.filterEngine = new FilterEngine();
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadData();
                this.updateLastUpdateTime();
            }

            async loadData() {
                this.showLoading('Conectando à planilha...');
                
                try {
                    const data = await this.dataManager.fetchData();
                    if (data && data.length > 0) {
                        appState.allData = data;
                        this.applyFilters();
                        this.hideLoading();
                    } else {
                        this.showError('Não foi possível carregar os dados da planilha');
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    this.showError('Erro de conexão. Verifique o acesso à planilha.');
                }
            }

            applyFilters() {
                // Coletar filtros
                const filters = {
                    search: elements.searchInput.value,
                    quick: elements.quickFilter.value,
                    territorio: elements.territorioFilter.value,
                    tipo: elements.tipoFilter.value,
                    vacina: elements.vacinaFilter.value,
                    equipe: elements.equipeFilter.value
                };

                appState.filters = filters;
                
                // Aplicar filtros
                appState.filteredData = this.filterEngine.applyFilters(appState.allData, filters);
                
                // Ordenar
                appState.filteredData = this.filterEngine.sortData(
                    appState.filteredData, 
                    appState.currentSort.field, 
                    appState.currentSort.direction
                );
                
                // Atualizar UI
                this.renderer.renderResults(appState.filteredData);
                this.updateMetrics();
                this.updateResultCount();
            }

            updateMetrics() {
                const data = appState.filteredData;
                
                elements.totalUnits.textContent = data.length;
                elements.vacinaUnits.textContent = data.filter(u => u.sala_vacina_ativa?.includes('Sim')).length;
                elements.territoriosCount.textContent = new Set(data.map(u => u.territorio).filter(Boolean)).size;
                elements.esfUnits.textContent = data.filter(u => u.unidade?.includes('ESF')).length;
            }

            updateResultCount() {
                const total = appState.filteredData.length;
                const selected = appState.filters.search || appState.filters.quick || 
                               appState.filters.territorio || appState.filters.tipo || 
                               appState.filters.vacina || appState.filters.equipe;
                
                elements.resultCount.textContent = `${total} unidade${total !== 1 ? 's' : ''}`;
                
                if (selected && appState.allData.length !== total) {
                    elements.selectedCount.textContent = `(${total} de ${appState.allData.length} filtradas)`;
                } else {
                    elements.selectedCount.textContent = '';
                }
            }

            updateLastUpdateTime() {
                const timestamp = localStorage.getItem('saude-pf-last-update');
                if (timestamp) {
                    const date = new Date(parseInt(timestamp));
                    elements.lastUpdate.textContent = `Última atualização: ${date.toLocaleString('pt-BR')}`;
                }
            }

            showLoading(message = 'Carregando...') {
                elements.loadingState.classList.remove('hidden');
                elements.cardsView.classList.add('hidden');
                elements.tableView.classList.add('hidden');
                elements.noResults.classList.add('hidden');
                elements.loadingDetail.textContent = message;
            }

            hideLoading() {
                elements.loadingState.classList.add('hidden');
            }

            showError(message) {
                this.hideLoading();
                // Em uma versão mais elaborada, poderia mostrar um toast de erro
                console.error(message);
                alert(`Erro: ${message}`);
            }

            setupEventListeners() {
                // Busca em tempo real com debounce
                let searchTimeout;
                elements.searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => this.applyFilters(), 300);
                });

                // Filtros
                [elements.quickFilter, elements.territorioFilter, elements.tipoFilter, 
                 elements.vacinaFilter, elements.equipeFilter].forEach(filter => {
                    filter.addEventListener('change', () => this.applyFilters());
                });

                // Limpar filtros
                elements.clearFilters.addEventListener('click', () => {
                    elements.searchInput.value = '';
                    elements.quickFilter.value = '';
                    elements.territorioFilter.value = '';
                    elements.tipoFilter.value = '';
                    elements.vacinaFilter.value = '';
                    elements.equipeFilter.value = '';
                    this.applyFilters();
                });

                // Alternar visualização
                elements.toggleView.addEventListener('click', () => {
                    appState.currentView = appState.currentView === 'cards' ? 'table' : 'cards';
                    elements.toggleView.innerHTML = appState.currentView === 'cards' 
                        ? '<i class="fas fa-th-large mr-1"></i> Visualização em Tabela'
                        : '<i class="fas fa-grip-horizontal mr-1"></i> Visualização em Cards';
                    this.applyFilters();
                });

                // Ordenação da tabela
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.sortable')) {
                        const field = e.target.closest('.sortable').dataset.sort;
                        this.sortTable(field);
                    }
                });

                // Ações principais
                elements.refreshBtn.addEventListener('click', async () => {
                    localStorage.removeItem('saude-pf-data');
                    localStorage.removeItem('saude-pf-last-update');
                    await this.loadData();
                });

                elements.exportBtn.addEventListener('click', () => {
                    this.exportToPDF();
                });

                // Modal
                elements.closeModal.addEventListener('click', () => {
                    elements.unitModal.classList.add('hidden');
                });

                elements.unitModal.addEventListener('click', (e) => {
                    if (e.target === elements.unitModal) {
                        elements.unitModal.classList.add('hidden');
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        elements.unitModal.classList.add('hidden');
                    }
                });
            }

            sortTable(field) {
                if (appState.currentSort.field === field) {
                    appState.currentSort.direction = appState.currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    appState.currentSort = { field, direction: 'asc' };
                }
                this.applyFilters();
            }

            exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text('Relatório de Unidades de Saúde - Passo Fundo', 20, 20);
                
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 20, 30);
                doc.text(`Total de unidades: ${appState.filteredData.length}`, 20, 40);
                
                let y = 50;
                appState.filteredData.forEach((unit, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${unit.unidade || 'N/A'}`, 20, y);
                    y += 6;
                    
                    doc.setFont(undefined, 'normal');
                    if (unit.enfermeiro) {
                        doc.text(`   Enfermeiro: ${unit.enfermeiro}`, 25, y);
                        y += 5;
                    }
                    if (unit.telefone) {
                        doc.text(`   Telefone: ${unit.telefone}`, 25, y);
                        y += 5;
                    }
                    if (unit.endereco) {
                        doc.text(`   Endereço: ${unit.endereco}`, 25, y);
                        y += 5;
                    }
                    y += 3;
                });
                
                doc.save(`unidades-saude-${new Date().toISOString().split('T')[0]}.pdf`);
            }
        }

        // Gerenciador de dados
        class DataManager {
            async fetchData() {
                // Verificar cache
                const cached = this.getCachedData();
                if (cached) return cached;

                // Buscar dados atualizados
                const freshData = await this.fetchFromSheets();
                if (freshData && freshData.length > 0) {
                    this.setCachedData(freshData);
                    localStorage.setItem('saude-pf-last-update', Date.now().toString());
                }
                return freshData;
            }

            async fetchFromSheets() {
                try {
                    // Usando opensheet.elk.sh como proxy (funciona sem CORS)
                    const response = await fetch(
                        `https://opensheet.elk.sh/${CONFIG.spreadsheetId}/${CONFIG.gid}`
                    );
                    
                    if (!response.ok) throw new Error('Erro na resposta da API');
                    
                    const data = await response.json();
                    return this.processData(data);
                } catch (error) {
                    console.error('Erro ao buscar dados:', error);
                    return this.getFallbackData();
                }
            }

            processData(data) {
                return data.map(row => ({
                    // Mapeamento dinâmico das colunas
                    unidade: row.UNIDADE || row.unidade || '',
                    enfermeiro: row.ENFERMEIRO || row.enfermeiro || '',
                    tecnico_enfermagem: row['TEC. ENFERMAGEM'] || row.tecnico_enfermagem || '',
                    medico: row.MEDICO || row.medico || '',
                    odonto: row.ODONTO || row.odonto || '',
                    multi: row.MULTI || row.multi || '',
                    acs: row.ACS || row.acs || '',
                    ace: row.ACE || row.ace || '',
                    gerente: row.GERENTE || row.gerente || '',
                    email: row.EMAIL || row.email || '',
                    recepcao: row.RECEPÇÃO || row.recepcao || '',
                    sanificacao: row.SANIFICAÇÃO || row.sanificacao || '',
                    porteiro: row.PORTEIRO || row.porteiro || '',
                    telefone: row.TELEFONE || row.telefone || '',
                    endereco: row.ENDEREÇO || row.endereco || '',
                    sala_vacina_ativa: row['Sala de Vacina ativa'] || row.sala_vacina_ativa || '',
                    atividades: row.Atividades || row.atividades || '',
                    territorio: row.Território || row.territorio || ''
                }));
            }

            getCachedData() {
                try {
                    const cached = localStorage.getItem('saude-pf-data');
                    const timestamp = localStorage.getItem('saude-pf-last-update');
                    
                    if (cached && timestamp) {
                        const age = Date.now() - parseInt(timestamp);
                        if (age < CONFIG.cacheTimeout) {
                            return JSON.parse(cached);
                        }
                    }
                } catch (e) {
                    console.warn('Erro ao acessar cache:', e);
                }
                return null;
            }

            setCachedData(data) {
                try {
                    localStorage.setItem('saude-pf-data', JSON.stringify(data));
                } catch (e) {
                    console.warn('Erro ao salvar cache:', e);
                }
            }

            getFallbackData() {
                // Dados de fallback para demonstração
                return [
                    {
                        unidade: "ESF 1º Centenário",
                        enfermeiro: "Talita Kiffer Gomes Oliveira",
                        gerente: "Fabiana Veronese",
                        telefone: "3315-7870",
                        endereco: "R. Dr. Gelson Ribeiro, 148 - Vera Cruz / 1º Centenário",
                        email: "esfcentenario@pmpf.rs.gov.br",
                        sala_vacina_ativa: "Não",
                        territorio: "UPF"
                    }
                ];
            }
        }

        // Motor de filtros
        class FilterEngine {
            applyFilters(data, filters) {
                return data.filter(item => {
                    // Filtro de busca geral
                    if (filters.search) {
                        const searchTerm = filters.search.toLowerCase();
                        const searchable = [
                            item.unidade, item.enfermeiro, item.gerente,
                            item.endereco, item.telefone, item.email,
                            item.territorio
                        ].join(' ').toLowerCase();
                        
                        if (!searchable.includes(searchTerm)) return false;
                    }

                    // Filtro rápido
                    if (filters.quick) {
                        const [type, value] = filters.quick.split(':');
                        if (type === 'vacina' && !item.sala_vacina_ativa?.includes(value)) return false;
                        if (type === 'tipo' && !item.unidade?.includes(value)) return false;
                        if (type === 'territorio' && item.territorio !== value) return false;
                    }

                    // Filtros individuais
                    if (filters.territorio && item.territorio !== filters.territorio) return false;
                    if (filters.tipo && !item.unidade?.includes(filters.tipo)) return false;
                    
                    if (filters.vacina === 'Sim' && !item.sala_vacina_ativa?.includes('Sim')) return false;
                    if (filters.vacina === 'Não' && item.sala_vacina_ativa?.includes('Sim')) return false;
                    
                    if (filters.equipe === 'medico' && !item.medico) return false;
                    if (filters.equipe === 'odonto' && !item.odonto) return false;
                    if (filters.equipe === 'multi' && !item.multi) return false;

                    return true;
                });
            }

            sortData(data, field, direction) {
                return [...data].sort((a, b) => {
                    let aVal = a[field] || '';
                    let bVal = b[field] || '';
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            }
        }

        // Renderizador
        class Renderer {
            renderResults(data) {
                if (data.length === 0) {
                    this.showNoResults();
                    return;
                }

                if (appState.currentView === 'cards') {
                    this.renderCards(data);
                } else {
                    this.renderTable(data);
                }
            }

            renderCards(data) {
                elements.cardsView.innerHTML = '';
                elements.tableView.classList.add('hidden');
                elements.cardsView.classList.remove('hidden');
                
                data.forEach(unit => {
                    const card = this.createCard(unit);
                    elements.cardsView.appendChild(card);
                });
            }

            createCard(unit) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm p-5 card-hover contact-card border-l-4 border-blue-500';
                card.style.borderLeftColor = this.getTerritoryColor(unit.territorio);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-gray-800 text-lg leading-tight">${unit.unidade || 'Unidade'}</h3>
                        <span class="text-xs font-medium px-2 py-1 rounded-full ${unit.sala_vacina_ativa?.includes('Sim') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${unit.sala_vacina_ativa?.includes('Sim') ? 'Vacina ✓' : 'Sem Vacina'}
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${unit.enfermeiro ? `
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-user-nurse mr-2 w-4 text-blue-500"></i>
                                <span class="truncate">${this.formatName(unit.enfermeiro)}</span>
                            </div>
                        ` : ''}
                        
                        ${unit.gerente ? `
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-user-tie mr-2 w-4 text-green-500"></i>
                                <span>${unit.gerente}</span>
                            </div>
                        ` : ''}
                        
                        ${unit.territorio ? `
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt mr-2 w-4 text-purple-500"></i>
                                <span>${unit.territorio}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="border-t pt-3">
                        <div class="flex justify-between items-center">
                            <div class="flex space-x-2">
                                ${unit.telefone ? `
                                    <button onclick="event.stopPropagation(); app.openContact('phone', '${unit.telefone}')" 
                                            class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition-colors"
                                            title="Ligar">
                                        <i class="fas fa-phone text-sm"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); app.openContact('whatsapp', '${unit.telefone}')" 
                                            class="text-green-600 hover:text-green-800 p-2 rounded-full hover:bg-green-50 transition-colors"
                                            title="WhatsApp">
                                        <i class="fab fa-whatsapp text-sm"></i>
                                    </button>
                                ` : ''}
                                
                                ${unit.email ? `
                                    <button onclick="event.stopPropagation(); app.openContact('email', '${unit.email}')" 
                                            class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition-colors"
                                            title="Email">
                                        <i class="fas fa-envelope text-sm"></i>
                                    </button>
                                ` : ''}
                                
                                ${unit.endereco ? `
                                    <button onclick="event.stopPropagation(); app.openContact('maps', '${unit.endereco}')" 
                                            class="text-purple-600 hover:text-purple-800 p-2 rounded-full hover:bg-purple-50 transition-colors"
                                            title="Ver no Maps">
                                        <i class="fas fa-map-marker-alt text-sm"></i>
                                    </button>
                                ` : ''}
                            </div>
                            
                            <button onclick="app.showUnitDetails(${JSON.stringify(unit).replace(/"/g, '&quot;')})"
                                    class="text-gray-600 hover:text-gray-800 text-sm font-medium flex items-center">
                                Detalhes <i class="fas fa-chevron-right ml-1 text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => this.showUnitDetails(unit));
                return card;
            }

            renderTable(data) {
                elements.tableView.classList.remove('hidden');
                elements.cardsView.classList.add('hidden');
                
                elements.tableBody.innerHTML = data.map(unit => `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${unit.unidade || '-'}</div>
                            ${unit.territorio ? `<div class="text-sm text-gray-500">${unit.territorio}</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${this.formatName(unit.enfermeiro) || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex space-x-3">
                                ${unit.telefone ? `
                                    <button onclick="app.openContact('phone', '${unit.telefone}')" 
                                            class="text-blue-600 hover:text-blue-800 transition-colors"
                                            title="Ligar">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                    <button onclick="app.openContact('whatsapp', '${unit.telefone}')" 
                                            class="text-green-600 hover:text-green-800 transition-colors"
                                            title="WhatsApp">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                ` : ''}
                                ${unit.email ? `
                                    <button onclick="app.openContact('email', '${unit.email}')" 
                                            class="text-red-600 hover:text-red-800 transition-colors"
                                            title="Email">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                ` : ''}
                                ${unit.endereco ? `
                                    <button onclick="app.openContact('maps', '${unit.endereco}')" 
                                            class="text-purple-600 hover:text-purple-800 transition-colors"
                                            title="Maps">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${unit.sala_vacina_ativa?.includes('Sim') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${unit.sala_vacina_ativa || 'Não'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${unit.territorio || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="app.showUnitDetails(${JSON.stringify(unit).replace(/"/g, '&quot;')})"
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Ver <i class="fas fa-external-link-alt ml-1"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            showNoResults() {
                elements.cardsView.classList.add('hidden');
                elements.tableView.classList.add('hidden');
                elements.noResults.classList.remove('hidden');
            }

            formatName(name) {
                if (!name) return '';
                // Pegar primeiro nome para display
                return name.split('(')[0].split(',')[0].trim();
            }

            getTerritoryColor(territorio) {
                const colors = {
                    'UPF': '#3b82f6',
                    'UFFS': '#10b981', 
                    'IMED': '#8b5cf6',
                    'FASURGS': '#f59e0b'
                };
                return colors[territorio] || '#6b7280';
            }

            showUnitDetails(unit) {
                elements.modalTitle.textContent = unit.unidade || 'Unidade de Saúde';
                elements.modalSubtitle.textContent = unit.territorio ? `Território: ${unit.territorio}` : '';
                
                let content = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <i class="fas fa-info-circle mr-2"></i> Informações Principais
                                </h4>
                                <div class="space-y-2 text-sm">
                                    ${unit.enfermeiro ? `<p><strong>Enfermeiro:</strong><br>${unit.enfermeiro}</p>` : ''}
                                    ${unit.gerente ? `<p><strong>Gerente:</strong><br>${unit.gerente}</p>` : ''}
                                    ${unit.sala_vacina_ativa ? `<p><strong>Sala de Vacina:</strong><br>${unit.sala_vacina_ativa}</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="bg-green-50 rounded-lg p-4">
                                <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                                    <i class="fas fa-users mr-2"></i> Equipe
                                </h4>
                                <div class="space-y-1 text-sm">
                                    ${unit.tecnico_enfermagem ? `<p><strong>Téc. Enfermagem:</strong><br>${unit.tecnico_enfermagem}</p>` : ''}
                                    ${unit.medico ? `<p><strong>Médico:</strong><br>${unit.medico}</p>` : ''}
                                    ${unit.odonto ? `<p><strong>Odonto:</strong><br>${unit.odonto}</p>` : ''}
                                    ${unit.multi ? `<p><strong>Multiprofissional:</strong><br>${unit.multi}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-purple-50 rounded-lg p-4">
                                <h4 class="font-semibold text-purple-800 mb-2 flex items-center">
                                    <i class="fas fa-address-book mr-2"></i> Contatos
                                </h4>
                                <div class="space-y-3">
                                    ${unit.telefone ? `
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm"><strong>Telefone:</strong><br>${unit.telefone}</span>
                                            <div class="flex space-x-1">
                                                <button onclick="app.openContact('phone', '${unit.telefone}')" 
                                                        class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full transition-colors">
                                                    <i class="fas fa-phone text-sm"></i>
                                                </button>
                                                <button onclick="app.openContact('whatsapp', '${unit.telefone}')" 
                                                        class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition-colors">
                                                    <i class="fab fa-whatsapp text-sm"></i>
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${unit.email ? `
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm"><strong>Email:</strong><br>${unit.email}</span>
                                            <button onclick="app.openContact('email', '${unit.email}')" 
                                                    class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition-colors">
                                                <i class="fas fa-envelope text-sm"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                    
                                    ${unit.endereco ? `
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm"><strong>Endereço:</strong><br>${unit.endereco}</span>
                                            <button onclick="app.openContact('maps', '${unit.endereco}')" 
                                                    class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-full transition-colors">
                                                <i class="fas fa-map-marker-alt text-sm"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${unit.atividades ? `
                                <div class="bg-orange-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-orange-800 mb-2 flex items-center">
                                        <i class="fas fa-tasks mr-2"></i> Atividades
                                    </h4>
                                    <p class="text-sm">${unit.atividades}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                elements.modalContent.innerHTML = content;
                elements.unitModal.classList.remove('hidden');
            }
        }

        // Instanciar e tornar global para os event listeners
        const app = new HealthDashboardApp();

        // Métodos globais para os event listeners
        window.app = {
            showUnitDetails: (unit) => {
                const renderer = new Renderer();
                renderer.showUnitDetails(unit);
            },
            
            openContact: (type, value) => {
                switch (type) {
                    case 'phone':
                        window.open(`tel:${value.replace(/\D/g, '')}`, '_self');
                        break;
                    case 'whatsapp':
                        window.open(`https://wa.me/55${value.replace(/\D/g, '')}`, '_blank');
                        break;
                    case 'email':
                        window.open(`mailto:${value}`, '_blank');
                        break;
                    case 'maps':
                        window.open(`https://maps.google.com/?q=${encodeURIComponent(value + ', Passo Fundo, RS')}`, '_blank');
                        break;
                }
            }
        };
    </script>
</body>
</html>
