<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão em Saúde - Passo Fundo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Normalize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #059669;
            --accent-color: #7c3aed;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <i class="fas fa-hospital-alt text-2xl text-blue-600 mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Gestão em Saúde - Passo Fundo</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i> Atualizar Dados
                    </button>
                    
                    <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                        <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Filtros e Busca -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buscar Unidade/Profissional</label>
                    <input type="text" id="searchInput" placeholder="Digite para buscar..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Território</label>
                    <select id="territorioFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Todos os Territórios</option>
                        <option value="UPF">UPF</option>
                        <option value="UFFS">UFFS</option>
                        <option value="IMED">IMED</option>
                        <option value="FASURGS">FASURGS</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Tipo</label>
                    <select id="tipoFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Todos os Tipos</option>
                        <option value="ESF">ESF</option>
                        <option value="UBS">UBS</option>
                        <option value="CAPS">CAPS</option>
                        <option value="CAIS">CAIS</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Vacina</label>
                    <select id="vacinaFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Todos</option>
                        <option value="Sim">Com Sala de Vacina</option>
                        <option value="Não">Sem Sala de Vacina</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <button id="clearFilters" class="text-gray-600 hover:text-gray-800 flex items-center transition-colors">
                    <i class="fas fa-times mr-1"></i> Limpar Filtros
                </button>
                
                <div class="text-sm text-gray-600">
                    <span id="resultCount">0</span> unidades encontradas
                </div>
            </div>
        </div>

        <!-- Métricas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-hospital text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total de Unidades</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="totalUnits">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-syringe text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Com Sala de Vacina</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="vacinaUnits">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg bg-purple-100 text-purple-600 mr-4">
                        <i class="fas fa-map-marker-alt text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Diferentes Territórios</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="territoriosCount">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg bg-orange-100 text-orange-600 mr-4">
                        <i class="fas fa-user-nurse text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Unidades ESF</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="esfUnits">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Unidades -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden fade-in">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Unidades de Saúde</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="unidade">
                                Unidade <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="enfermeiro">
                                Enfermeiro <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="gerente">
                                Gerente <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Contatos
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="vacina">
                                Vacina <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="territorio">
                                Território <i class="fas fa-sort ml-1"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dados serão carregados aqui -->
                    </tbody>
                </table>
            </div>
            
            <div id="loadingIndicator" class="p-8 text-center">
                <div class="loading mx-auto mb-2"></div>
                <p class="text-gray-600">Carregando dados...</p>
            </div>
            
            <div id="noResults" class="p-8 text-center hidden">
                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-600">Nenhuma unidade encontrada com os filtros aplicados.</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-gray-600 mb-4 md:mb-0">
                    <p>Dados atualizados da planilha oficial de saúde</p>
                </div>
                <div class="text-gray-500 text-sm">
                    <p>Última atualização: <span id="lastUpdate">-</span></p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal de Detalhes -->
    <div id="unitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Detalhes da Unidade</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6" id="modalContent">
                <!-- Conteúdo do modal será preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Configurações
        const CONFIG = {
            spreadsheetId: '1QTPypA8lmlqeSveShPBI4HY9up6cOUcfulGDAyrP_BQ',
            gid: '291026320',
            apiKey: 'AIzaSyBzq9x9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9', // Esta é uma chave de exemplo - substitua pela sua
            cacheTimeout: 15 * 60 * 1000 // 15 minutos
        };

        // Estado da aplicação
        let appState = {
            allData: [],
            filteredData: [],
            currentSort: { field: 'unidade', direction: 'asc' },
            filters: {
                search: '',
                territorio: '',
                tipo: '',
                vacina: ''
            }
        };

        // Elementos DOM
        const elements = {
            tableBody: document.getElementById('tableBody'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            noResults: document.getElementById('noResults'),
            searchInput: document.getElementById('searchInput'),
            territorioFilter: document.getElementById('territorioFilter'),
            tipoFilter: document.getElementById('tipoFilter'),
            vacinaFilter: document.getElementById('vacinaFilter'),
            clearFilters: document.getElementById('clearFilters'),
            refreshBtn: document.getElementById('refreshBtn'),
            exportBtn: document.getElementById('exportBtn'),
            resultCount: document.getElementById('resultCount'),
            totalUnits: document.getElementById('totalUnits'),
            vacinaUnits: document.getElementById('vacinaUnits'),
            territoriosCount: document.getElementById('territoriosCount'),
            esfUnits: document.getElementById('esfUnits'),
            lastUpdate: document.getElementById('lastUpdate'),
            unitModal: document.getElementById('unitModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModal: document.getElementById('closeModal')
        };

        // Gerenciador de dados
        class DataManager {
            constructor() {
                this.cacheKey = 'saude-pf-data';
                this.lastUpdateKey = 'saude-pf-last-update';
            }

            async fetchData() {
                // Verificar cache primeiro
                const cached = this.getCachedData();
                if (cached) {
                    console.log('Usando dados em cache');
                    return cached;
                }

                // Buscar dados atualizados
                console.log('Buscando dados atualizados...');
                const freshData = await this.fetchFromSheets();
                if (freshData && freshData.length > 0) {
                    this.setCachedData(freshData);
                    this.setLastUpdate();
                }
                return freshData;
            }

            async fetchFromSheets() {
                try {
                    // Para GitHub Pages, vamos usar uma abordagem mais simples
                    // Em produção, você precisaria de uma chave API válida
                    const response = await fetch(
                        `https://opensheet.elk.sh/${CONFIG.spreadsheetId}/${CONFIG.gid}`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar dados');
                    }
                    
                    const data = await response.json();
                    return this.processSheetData(data);
                } catch (error) {
                    console.error('Erro ao buscar dados:', error);
                    // Tentar usar dados de exemplo se a API falhar
                    return this.getSampleData();
                }
            }

            processSheetData(data) {
                if (!data || data.length === 0) return [];
                
                return data.map(row => {
                    // Mapear colunas dinamicamente
                    return {
                        unidade: row.UNIDADE || row.unidade || '',
                        enfermeiro: row.ENFERMEIRO || row.enfermeiro || '',
                        tecnico_enfermagem: row['TEC. ENFERMAGEM'] || row.tecnico_enfermagem || '',
                        medico: row.MEDICO || row.medico || '',
                        odonto: row.ODONTO || row.odonto || '',
                        multi: row.MULTI || row.multi || '',
                        acs: row.ACS || row.acs || '',
                        ace: row.ACE || row.ace || '',
                        gerente: row.GERENTE || row.gerente || '',
                        email: row.EMAIL || row.email || '',
                        recepcao: row.RECEPÇÃO || row.recepcao || '',
                        sanificacao: row.SANIFICAÇÃO || row.sanificacao || '',
                        porteiro: row.PORTEIRO || row.porteiro || '',
                        telefone: row.TELEFONE || row.telefone || '',
                        endereco: row.ENDEREÇO || row.endereco || '',
                        sala_vacina_ativa: row['Sala de Vacina ativa'] || row.sala_vacina_ativa || '',
                        atividades: row.Atividades || row.atividades || '',
                        territorio: row.Território || row.territorio || ''
                    };
                });
            }

            getCachedData() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    const timestamp = localStorage.getItem(this.lastUpdateKey);
                    
                    if (cached && timestamp) {
                        const age = Date.now() - parseInt(timestamp);
                        if (age < CONFIG.cacheTimeout) {
                            return JSON.parse(cached);
                        }
                    }
                } catch (e) {
                    console.warn('Erro ao acessar cache:', e);
                }
                return null;
            }

            setCachedData(data) {
                try {
                    localStorage.setItem(this.cacheKey, JSON.stringify(data));
                    this.setLastUpdate();
                } catch (e) {
                    console.warn('Erro ao salvar cache:', e);
                }
            }

            setLastUpdate() {
                try {
                    localStorage.setItem(this.lastUpdateKey, Date.now().toString());
                    elements.lastUpdate.textContent = new Date().toLocaleString('pt-BR');
                } catch (e) {
                    console.warn('Erro ao salvar timestamp:', e);
                }
            }

            getSampleData() {
                // Dados de exemplo para demonstração
                return [
                    {
                        unidade: "ESF 1º Centenário",
                        enfermeiro: "Talita Kiffer Gomes Oliveira",
                        gerente: "Fabiana Veronese",
                        telefone: "3315-7870",
                        endereco: "R. Dr. Gelson Ribeiro, 148 - Vera Cruz / 1º Centenário",
                        email: "esfcentenario@pmpf.rs.gov.br",
                        sala_vacina_ativa: "Não",
                        territorio: "UPF"
                    },
                    {
                        unidade: "ESF Adirbal Corralo", 
                        enfermeiro: "Solange Soares, Adiane Bagatini",
                        gerente: "Fabiana Veronese",
                        telefone: "3314-8344",
                        endereco: "R. Uruguaiana, s/n° - Vila Fátima",
                        email: "esfadirbal@pmpf.rs.gov.br",
                        sala_vacina_ativa: "Sim vac COVID",
                        territorio: "UPF"
                    }
                ];
            }
        }

        // Motor de busca
        class SearchEngine {
            constructor(data) {
                this.data = data;
            }

            search(term, filters) {
                if (!term && !filters.territorio && !filters.tipo && !filters.vacina) {
                    return this.data;
                }

                const searchTerm = term ? term.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';
                
                return this.data.filter(item => {
                    // Busca por termo
                    if (searchTerm) {
                        const searchableFields = [
                            item.unidade, 
                            item.enfermeiro, 
                            item.gerente, 
                            item.endereco,
                            item.territorio
                        ].join(' ').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                        
                        if (!searchableFields.includes(searchTerm)) {
                            return false;
                        }
                    }

                    // Filtros
                    if (filters.territorio && item.territorio !== filters.territorio) {
                        return false;
                    }

                    if (filters.tipo) {
                        const unitType = item.unidade ? item.unidade.split(' ')[0] : '';
                        if (unitType !== filters.tipo) {
                            return false;
                        }
                    }

                    if (filters.vacina) {
                        if (filters.vacina === 'Sim' && !item.sala_vacina_ativa?.includes('Sim')) {
                            return false;
                        }
                        if (filters.vacina === 'Não' && item.sala_vacina_ativa?.includes('Sim')) {
                            return false;
                        }
                    }

                    return true;
                });
            }

            sort(data, field, direction) {
                return [...data].sort((a, b) => {
                    let aValue = a[field] || '';
                    let bValue = b[field] || '';
                    
                    if (typeof aValue === 'string') {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }
                    
                    if (direction === 'asc') {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });
            }
        }

        // Renderizador da tabela
        class TableRenderer {
            constructor() {
                this.searchEngine = new SearchEngine([]);
            }

            renderTable(data) {
                elements.tableBody.innerHTML = '';
                
                if (data.length === 0) {
                    elements.loadingIndicator.classList.add('hidden');
                    elements.noResults.classList.remove('hidden');
                    return;
                }
                
                elements.noResults.classList.add('hidden');
                
                const sortedData = this.searchEngine.sort(data, appState.currentSort.field, appState.currentSort.direction);
                
                sortedData.forEach((unit, index) => {
                    const row = this.createTableRow(unit, index);
                    elements.tableBody.appendChild(row);
                });
                
                this.updateSortIcons();
            }

            createTableRow(unit, index) {
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 cursor-pointer ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
                row.addEventListener('click', () => this.showUnitDetails(unit));
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${unit.unidade || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${this.formatEnfermeiro(unit.enfermeiro)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${unit.gerente || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex space-x-2">
                            ${unit.telefone ? `
                                <a href="tel:${this.cleanPhone(unit.telefone)}" 
                                   class="text-blue-600 hover:text-blue-800 transition-colors"
                                   onclick="event.stopPropagation()">
                                    <i class="fas fa-phone"></i>
                                </a>
                                <a href="https://wa.me/55${this.cleanPhone(unit.telefone)}" 
                                   class="text-green-600 hover:text-green-800 transition-colors"
                                   onclick="event.stopPropagation()">
                                    <i class="fab fa-whatsapp"></i>
                                </a>
                            ` : ''}
                            ${unit.email ? `
                                <a href="mailto:${unit.email}" 
                                   class="text-red-600 hover:text-red-800 transition-colors"
                                   onclick="event.stopPropagation()">
                                    <i class="fas fa-envelope"></i>
                                </a>
                            ` : ''}
                            ${unit.endereco ? `
                                <a href="https://maps.google.com/?q=${encodeURIComponent(unit.endereco + ', Passo Fundo, RS')}" 
                                   target="_blank"
                                   class="text-purple-600 hover:text-purple-800 transition-colors"
                                   onclick="event.stopPropagation()">
                                    <i class="fas fa-map-marker-alt"></i>
                                </a>
                            ` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${unit.sala_vacina_ativa?.includes('Sim') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${unit.sala_vacina_ativa || 'Não'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${unit.territorio || '-'}</div>
                    </td>
                `;
                
                return row;
            }

            formatEnfermeiro(enfermeiro) {
                if (!enfermeiro) return '-';
                // Pegar apenas o primeiro nome para simplificar
                const firstPart = enfermeiro.split('(')[0].split(',')[0].trim();
                return firstPart.length > 30 ? firstPart.substring(0, 30) + '...' : firstPart;
            }

            cleanPhone(phone) {
                return phone ? phone.replace(/\D/g, '') : '';
            }

            updateSortIcons() {
                document.querySelectorAll('.sortable i').forEach(icon => {
                    icon.className = 'fas fa-sort ml-1';
                });
                
                const currentSortIcon = document.querySelector(`[data-sort="${appState.currentSort.field}"] i`);
                if (currentSortIcon) {
                    currentSortIcon.className = appState.currentSort.direction === 'asc' 
                        ? 'fas fa-sort-up ml-1' 
                        : 'fas fa-sort-down ml-1';
                }
            }

            showUnitDetails(unit) {
                elements.modalTitle.textContent = unit.unidade || 'Detalhes da Unidade';
                
                let content = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Informações Principais</h4>
                                <div class="space-y-2">
                                    ${unit.enfermeiro ? `<p><strong>Enfermeiro:</strong> ${unit.enfermeiro}</p>` : ''}
                                    ${unit.gerente ? `<p><strong>Gerente:</strong> ${unit.gerente}</p>` : ''}
                                    ${unit.territorio ? `<p><strong>Território:</strong> ${unit.territorio}</p>` : ''}
                                    ${unit.sala_vacina_ativa ? `<p><strong>Sala de Vacina:</strong> ${unit.sala_vacina_ativa}</p>` : ''}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Contatos</h4>
                                <div class="space-y-2">
                                    ${unit.telefone ? `<p><strong>Telefone:</strong> ${unit.telefone}</p>` : ''}
                                    ${unit.email ? `<p><strong>Email:</strong> ${unit.email}</p>` : ''}
                                    ${unit.endereco ? `<p><strong>Endereço:</strong> ${unit.endereco}</p>` : ''}
                                </div>
                            </div>
                        </div>
                `;
                
                // Adicionar equipe se disponível
                const teamMembers = [];
                if (unit.tecnico_enfermagem) teamMembers.push(`<strong>Téc. Enfermagem:</strong> ${unit.tecnico_enfermagem}`);
                if (unit.medico) teamMembers.push(`<strong>Médico:</strong> ${unit.medico}`);
                if (unit.odonto) teamMembers.push(`<strong>Odonto:</strong> ${unit.odonto}`);
                if (unit.multi) teamMembers.push(`<strong>Multiprofissional:</strong> ${unit.multi}`);
                
                if (teamMembers.length > 0) {
                    content += `
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Equipe</h4>
                            <div class="space-y-1">
                                ${teamMembers.join('<br>')}
                            </div>
                        </div>
                    `;
                }
                
                // Botões de ação
                content += `
                    <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                        ${unit.telefone ? `
                            <a href="tel:${this.cleanPhone(unit.telefone)}" 
                               class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                                <i class="fas fa-phone mr-2"></i> Ligar
                            </a>
                            <a href="https://wa.me/55${this.cleanPhone(unit.telefone)}" 
                               target="_blank"
                               class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                                <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                            </a>
                        ` : ''}
                        ${unit.email ? `
                            <a href="mailto:${unit.email}" 
                               class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                                <i class="fas fa-envelope mr-2"></i> Email
                            </a>
                        ` : ''}
                        ${unit.endereco ? `
                            <a href="https://maps.google.com/?q=${encodeURIComponent(unit.endereco + ', Passo Fundo, RS')}" 
                               target="_blank"
                               class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                                <i class="fas fa-map-marker-alt mr-2"></i> Ver no Maps
                            </a>
                        ` : ''}
                    </div>
                </div>
                `;
                
                elements.modalContent.innerHTML = content;
                elements.unitModal.classList.remove('hidden');
            }
        }

        // Atualizador de métricas
        class MetricsUpdater {
            updateMetrics(data) {
                const total = data.length;
                const comVacina = data.filter(unit => unit.sala_vacina_ativa?.includes('Sim')).length;
                const territorios = new Set(data.map(unit => unit.territorio).filter(Boolean)).size;
                const esfCount = data.filter(unit => unit.unidade?.includes('ESF')).length;
                
                elements.totalUnits.textContent = total;
                elements.vacinaUnits.textContent = comVacina;
                elements.territoriosCount.textContent = territorios;
                elements.esfUnits.textContent = esfCount;
                elements.resultCount.textContent = total;
            }
        }

        // Exportador PDF
        class PDFExporter {
            async exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Cabeçalho
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 40);
                doc.text('Relatório de Unidades de Saúde - Passo Fundo', 20, 30);
                
                // Data
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 20, 45);
                
                // Métricas
                doc.setFontSize(14);
                doc.setTextColor(60, 60, 60);
                doc.text('Métricas:', 20, 65);
                
                doc.setFontSize(12);
                let yPos = 75;
                doc.text(`• Total de Unidades: ${appState.filteredData.length}`, 25, yPos);
                yPos += 10;
                doc.text(`• Com Sala de Vacina: ${appState.filteredData.filter(u => u.sala_vacina_ativa?.includes('Sim')).length}`, 25, yPos);
                yPos += 10;
                doc.text(`• Territórios: ${new Set(appState.filteredData.map(u => u.territorio).filter(Boolean)).size}`, 25, yPos);
                
                // Lista de unidades
                yPos += 20;
                doc.setFontSize(14);
                doc.setTextColor(60, 60, 60);
                doc.text('Unidades:', 20, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                
                appState.filteredData.forEach((unit, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${unit.unidade || 'N/A'}`, 25, yPos);
                    
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                    doc.setTextColor(80, 80, 80);
                    
                    if (unit.enfermeiro) {
                        doc.text(`   Enfermeiro: ${unit.enfermeiro}`, 25, yPos);
                        yPos += 5;
                    }
                    
                    if (unit.telefone) {
                        doc.text(`   Telefone: ${unit.telefone}`, 25, yPos);
                        yPos += 5;
                    }
                    
                    yPos += 4;
                });
                
                doc.save(`unidades-saude-passo-fundo-${new Date().toISOString().split('T')[0]}.pdf`);
            }
        }

        // Aplicação principal
        class HealthDashboardApp {
            constructor() {
                this.dataManager = new DataManager();
                this.tableRenderer = new TableRenderer();
                this.metricsUpdater = new MetricsUpdater();
                this.pdfExporter = new PDFExporter();
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadData();
                this.updateLastUpdateTime();
            }

            async loadData() {
                elements.loadingIndicator.classList.remove('hidden');
                
                try {
                    const data = await this.dataManager.fetchData();
                    appState.allData = data;
                    this.applyFilters();
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    this.showError('Erro ao carregar dados. Verifique sua conexão.');
                } finally {
                    elements.loadingIndicator.classList.add('hidden');
                }
            }

            applyFilters() {
                const searchTerm = elements.searchInput.value;
                const territorio = elements.territorioFilter.value;
                const tipo = elements.tipoFilter.value;
                const vacina = elements.vacinaFilter.value;
                
                appState.filters = { search: searchTerm, territorio, tipo, vacina };
                
                this.tableRenderer.searchEngine = new SearchEngine(appState.allData);
                appState.filteredData = this.tableRenderer.searchEngine.search(searchTerm, { territorio, tipo, vacina });
                
                this.tableRenderer.renderTable(appState.filteredData);
                this.metricsUpdater.updateMetrics(appState.filteredData);
            }

            sortTable(field) {
                if (appState.currentSort.field === field) {
                    appState.currentSort.direction = appState.currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    appState.currentSort = { field, direction: 'asc' };
                }
                
                this.tableRenderer.renderTable(appState.filteredData);
            }

            setupEventListeners() {
                // Busca em tempo real
                elements.searchInput.addEventListener('input', () => {
                    this.applyFilters();
                });

                // Filtros
                elements.territorioFilter.addEventListener('change', () => {
                    this.applyFilters();
                });

                elements.tipoFilter.addEventListener('change', () => {
                    this.applyFilters();
                });

                elements.vacinaFilter.addEventListener('change', () => {
                    this.applyFilters();
                });

                // Limpar filtros
                elements.clearFilters.addEventListener('click', () => {
                    elements.searchInput.value = '';
                    elements.territorioFilter.value = '';
                    elements.tipoFilter.value = '';
                    elements.vacinaFilter.value = '';
                    this.applyFilters();
                });

                // Ordenação
                document.querySelectorAll('.sortable').forEach(element => {
                    element.addEventListener('click', (e) => {
                        const field = e.currentTarget.getAttribute('data-sort');
                        this.sortTable(field);
                    });
                });

                // Atualizar dados
                elements.refreshBtn.addEventListener('click', async () => {
                    // Limpar cache para forçar atualização
                    localStorage.removeItem('saude-pf-data');
                    localStorage.removeItem('saude-pf-last-update');
                    await this.loadData();
                });

                // Exportar PDF
                elements.exportBtn.addEventListener('click', () => {
                    this.pdfExporter.exportToPDF();
                });

                // Modal
                elements.closeModal.addEventListener('click', () => {
                    elements.unitModal.classList.add('hidden');
                });

                elements.unitModal.addEventListener('click', (e) => {
                    if (e.target === elements.unitModal) {
                        elements.unitModal.classList.add('hidden');
                    }
                });

                // Tecla ESC para fechar modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !elements.unitModal.classList.contains('hidden')) {
                        elements.unitModal.classList.add('hidden');
                    }
                });
            }

            updateLastUpdateTime() {
                try {
                    const timestamp = localStorage.getItem('saude-pf-last-update');
                    if (timestamp) {
                        elements.lastUpdate.textContent = new Date(parseInt(timestamp)).toLocaleString('pt-BR');
                    }
                } catch (e) {
                    console.warn('Erro ao cargar timestamp:', e);
                }
            }

            showError(message) {
                // Implementar notificação de erro se necessário
                console.error(message);
            }
        }

        // Inicializar a aplicação quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            new HealthDashboardApp();
        });
    </script>
</body>
</html>
